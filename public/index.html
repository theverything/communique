<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button id="close">Close the connection</button>

    <ul></ul>

    <div>
      <input type="text" id="message" />
      <button id="send">Send</button>
    </div>
    <script>
      (async function () {
        const button = document.querySelector("#close");
        const sendBtn = document.querySelector("#send");
        const msgInput = document.querySelector("#message");
        const eventList = document.querySelector("ul");

        const evtSource = new EventSource(
          "http://localhost:8080/api/notify?topic=all"
        );

        const objectKey = "iAv4z9nykrhelVM5CDs4Jg";
        const key = await window.crypto.subtle.importKey(
          "jwk",
          {
            k: objectKey,
            alg: "A128GCM",
            ext: true,
            key_ops: ["encrypt", "decrypt"],
            kty: "oct",
          },
          { name: "AES-GCM", length: 128 },
          true, // extractable
          ["encrypt", "decrypt"]
        );

        console.log(evtSource.withCredentials);
        console.log(evtSource.readyState);
        console.log(evtSource.url);

        function ab2str(buf) {
          return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        function str2ab(str) {
          var buf = new ArrayBuffer(str.length);
          var bufView = new Uint8Array(buf);
          for (var i = 0, strLen = str.length; i < strLen; i++) {
            bufView[i] = str.charCodeAt(i);
          }
          return buf;
        }

        function addEvent(content) {
          const newElement = document.createElement("li");

          newElement.textContent = content;
          eventList.appendChild(newElement);
        }

        evtSource.addEventListener(
          "open",
          () => {
            console.log("Connection to server opened.");
          },
          false
        );

        evtSource.addEventListener(
          "message",
          (e) => {
            const payload = str2ab(JSON.parse(e.data));

            window.crypto.subtle
              .decrypt(
                { name: "AES-GCM", iv: new Uint8Array(12) },
                key,
                payload
              )
              .then((decrypted) => {
                const decoded = new window.TextDecoder().decode(
                  new Uint8Array(decrypted)
                );
                const content = JSON.parse(decoded);
                addEvent(`message: ${content.nic} says "${content.msg}"`);
              })
              .catch((err) => {
                console.error(err);
              });
          },
          false
        );

        evtSource.addEventListener(
          "ping",
          (e) => {
            const obj = JSON.parse(e.data);

            addEvent("ping: " + obj.time);
          },
          false
        );

        evtSource.addEventListener(
          "error",
          (e) => {
            console.log("EventSource failed.", e);
          },
          false
        );

        button.onclick = function () {
          console.log("Connection closed");
          evtSource.close();
        };

        sendBtn.addEventListener("click", () => {
          const val = msgInput.value;

          window.crypto.subtle
            .encrypt(
              {
                name: "AES-GCM",
                iv: new Uint8Array(12) /* don't reuse key! */,
              },
              key,
              new TextEncoder().encode(
                JSON.stringify({ nic: "jeff", msg: val })
              )
            )
            .then((encrypted) => {
              console.log(ab2str(encrypted));
              fetch("/api/dispatch", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  topic: "all",
                  payload: ab2str(encrypted),
                }),
              });
            });

          msgInput.value = "";
        });
      })();
    </script>
  </body>
</html>
